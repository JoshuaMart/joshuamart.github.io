---
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';
import MainLayout from '../layouts/MainLayout.astro';
import Terminal from '../components/Terminal.astro';
import CveCard from '../components/CveCard.astro';
import BlogCard from '../components/BlogCard.astro';
import { siteConfig } from '../data/site';
import cves from '../data/cves.json';
import tools from '../data/tools.json';

// Get 1 most recent CVE
const latestCve = [...cves]
  .sort((a, b) => {
    const dateCompare = b.date.localeCompare(a.date);
    if (dateCompare !== 0) return dateCompare;
    const severityOrder = { Critical: 0, High: 1, Medium: 2, Low: 3 };
    return severityOrder[a.severity] - severityOrder[b.severity];
  })[0];

// Get 1 latest tool
const latestTool = tools[0];

// Get latest blog post
const posts = await getCollection('blog');
const latestPost = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime())[0];

// Language colors for tool card
const languageColors: Record<string, string> = {
  'Go': '#00ADD8',
  'Python': '#3776AB',
  'Rust': '#DEA584',
  'JavaScript': '#F7DF1E',
  'TypeScript': '#3178C6',
  'Ruby': '#CC342D',
  'Java': '#B07219',
  'PHP': '#777BB4',
};
---

<MainLayout title={`${siteConfig.name} - ${siteConfig.role} & ${siteConfig.secondaryRole}`}>
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <div class="mx-auto max-w-6xl px-4 py-24 sm:px-6 sm:py-32">
      <div class="flex flex-col items-center text-center">
        <!-- Name -->
        <h1 class="text-4xl font-bold tracking-tight text-text-main sm:text-5xl md:text-6xl">
          {siteConfig.name}
        </h1>
        
        <!-- Role -->
        <p class="mt-4 text-lg text-accent sm:text-xl">
          {siteConfig.role}
          <span class="mx-2 text-text-muted">|</span>
          {siteConfig.secondaryRole}
        </p>
        
        <!-- Terminal -->
        <Terminal class="mt-10 w-full max-w-xl" />
        
        <!-- CTA Buttons -->
        <div class="mt-10 flex flex-wrap items-center justify-center gap-4">
          <a
            href="/cves"
            class="inline-flex items-center gap-2 rounded-md bg-accent px-5 py-2.5 text-sm font-semibold text-background transition-colors hover:bg-accent-hover"
          >
            <Icon name="lucide:shield-alert" class="h-4 w-4" />
            View CVEs
          </a>
          <a
            href="/blog"
            class="inline-flex items-center gap-2 rounded-md border border-border bg-surface px-5 py-2.5 text-sm font-semibold text-text-main transition-colors hover:border-border-hover hover:bg-surface-elevated"
          >
            <Icon name="lucide:book-open" class="h-4 w-4" />
            Read Blog
          </a>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Latest Intelligence Section -->
  <section class="border-t border-border bg-surface/50">
    <div class="mx-auto max-w-6xl px-4 py-16 sm:px-6 sm:py-24">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-text-main sm:text-3xl">Latest Intelligence</h2>
        <a
          href="/cves"
          class="inline-flex items-center gap-1 text-sm text-text-muted transition-colors hover:text-accent"
        >
          View all work
          <Icon name="lucide:arrow-right" class="h-4 w-4" />
        </a>
      </div>
      
      <!-- Latest CVE + Tool + Blog Post -->
      <div class="mt-10 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {latestCve && (
          <CveCard
            id={latestCve.id}
            target={latestCve.target}
            type={latestCve.type}
            severity={latestCve.severity}
            date={latestCve.date}
            link={latestCve.link}
          />
        )}
        
        {latestTool && (
          <a
            href={latestTool.url}
            target="_blank"
            rel="noopener noreferrer"
            class="group flex flex-col rounded-lg border border-border bg-surface p-5 transition-all hover:border-border-hover"
          >
            <div class="flex items-start justify-between">
              <div class="flex h-10 w-10 items-center justify-center rounded-lg border border-border bg-surface-elevated text-accent">
                <Icon name={latestTool.icon} class="h-5 w-5" />
              </div>
              <Icon name="lucide:arrow-up-right" class="h-5 w-5 text-text-muted transition-colors group-hover:text-text-main" />
            </div>
            <h3 class="mt-4 font-semibold text-text-main">{latestTool.name}</h3>
            <p class="mt-2 flex-1 text-sm leading-relaxed text-text-muted">{latestTool.description}</p>
            <div class="mt-4 flex items-center gap-2">
              <span class="h-3 w-3 rounded-full" style={`background-color: ${languageColors[latestTool.language] || '#A3A3A3'}`}></span>
              <span class="text-sm text-text-muted">{latestTool.language}</span>
            </div>
          </a>
        )}
        
        {latestPost && (
          <BlogCard
            title={latestPost.data.title}
            description={latestPost.data.description}
            date={latestPost.data.date}
            slug={latestPost.id}
            tags={latestPost.data.tags}
            image={latestPost.data.image}
          />
        )}
      </div>
    </div>
  </section>
</MainLayout>
